<!DOCTYPE html>
<html>
<head>
    <title>UserPermTree</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Rally.ui.tree.extendedTreeItem",{alias:"widget.extendedTreeItem",extend:"Rally.ui.tree.TreeItem",config:{displayedFields:["Name","Description","TeamMembers"]},myColour:"white",initComponent:function(){this.callParent(arguments),this.addCls(Rally.util.Test.toBrowserTestCssClass(this.getRecord().getId())),this.addEvents("expand","collapse","draw","select","colourProject","colourEditor","colourViewer"),this.on("afterrender",function(){this._getAutoExpanded()&&this.setExpanded(!0),this.draw(),this._getAutoExpanded()&&this.fireEvent("expand",this)},this),this.on("colourProject",function(){this.colourMeProject();var bubbleUp=this.getBubbleTarget();bubbleUp.fireEvent("colourProject")},this),this.on("colourEditor",function(){this.colourMeEditor();var bubbleUp=this.getBubbleTarget();bubbleUp.fireEvent("colourEditor")},this),this.on("colourViewer",function(){this.colourMeViewer();var bubbleUp=this.getBubbleTarget();bubbleUp.fireEvent("colourViewer")},this)},colourMeViewer:function(){},colourMeEditor:function(){},colourMeProject:function(){},getMyColour:function(me){var app=this.up("#userApp"),colour=app._getWorkspaceColour();return app._workspaceRights()||(projColour=app._getProjectColour(me.getRecord()),projColour&&(colour=projColour)),colour},_getAutoExpanded:function(){var app=this.up("#userApp");return app.getSetting("autoExpand")},getContentTpl:function(){var me=this;return Ext.create("Ext.XTemplate",'<tpl if="this.canDrag()"><div class="icon drag"></div></tpl>',"{[this.getActionsGear()]}",'<div class="textContent ellipses" style="padding-left: 5px; border-left: 5px solid {[this.getMyColour()]}">{[this.getFormattedId()]} {[this.getSeparator()]}{Name} ({[this.getOwner()]})</div>','<div class="rightSide">',"</div>",{getMyColour:function(){return me.getMyColour(me)},canDrag:function(){return me.getCanDrag()},getActionsGear:function(){return me._buildActionsGearHtml()},getFormattedId:function(){var record=me.getRecord();return record.getField("FormattedID")?Rally.ui.renderer.RendererFactory.renderRecordField(record,"FormattedID"):""},getSeparator:function(){return this.getFormattedId()?"- ":""},getOwner:function(){var record=me.getRecord();return record.getField("Owner")?Rally.ui.renderer.RendererFactory.renderRecordField(record,"Owner"):""}})},draw:function(){var me=this;this.content&&this.content.destroy();var cls="treeItemContent";this.getSelectable()&&(cls+=" selectable"),this.expander?this.toggleExpander():this.expander=this.drawExpander(),this.insert(1,{xtype:"container",itemId:"treeItemContent",cls:cls,layout:{type:"hbox"},items:[{xtype:"component",renderTpl:this.getContentTpl(),renderData:this.getRenderData(),listeners:{afterrender:function(){this.setupListeners(),this.fireEvent("draw")},scope:this}}]})}}),Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",itemId:"userApp",id:"userApp",stateful:!0,permColours:{Admin:"orange",User:"white",Viewer:"lightblue",Editor:"lightgreen"},items:[{xtype:"container",layout:"hbox",items:[{xtype:"rallyusersearchcombobox",id:"userSelector",fieldLabel:"Choose a user: "},{xtype:"container",html:'<div style="margin-left: 10px; padding-left: 10px;padding-right: 20px">Permission Colour Coding:   </div>'},{xtype:"container",html:'<div style="margin-left: 10px; padding-left: 3px; padding-right: 10px; border-left: 5px solid red">Workspace Admin</div>'},{xtype:"container",html:'<div style="margin-left: 10px; padding-left: 3px; padding-right: 10px; border-left: 5px solid orange">Project Admin</div>'},{xtype:"container",html:'<div style="margin-left: 10px; padding-left: 3px; padding-right: 10px; border-left: 5px solid lightgreen">Project Editor</div>'},{xtype:"container",html:'<div style="margin-left: 10px; padding-left: 3px; padding-right: 10px; border-left: 5px solid lightblue">Project Viewer</div>'}]}],_fetchUserPermissions:function(){Deft.Chain.parallel([this._getProjectPerms,this._getWorkspacePerms],this).then({success:function(){this._redrawTree()},failure:function(){console.log("Failed to fetch user permissions")},scope:this})},projectPerms:null,_getProjectPerms:function(){var me=this,deferred=Ext.create("Deft.Deferred"),record=Ext.getCmp("userSelector").getRecord();if(record)var perStore=Ext.create("Rally.data.wsapi.Store",{model:"projectpermission",autoLoad:!0,pageSize:2e3,filters:[{property:"User",value:record.get("_ref")},{property:"Workspace",value:me.getContext().getWorkspace()._ref}],listeners:{load:function(store,data,success){success?(me.projectPerms=data,deferred.resolve(data)):deferred.reject()}}});return deferred.promise},_projectRights:function(){return!1},_getProjectColour:function(record){var roleRecord=_.find(this.projectPerms,function(perm){return perm.data.Project._ref===record.data._ref});return roleRecord?this.permColours[roleRecord.data.Role]:"white"},workspacePerms:null,_getWorkspacePerms:function(){var me=this,deferred=Ext.create("Deft.Deferred"),record=Ext.getCmp("userSelector").getRecord();if(record)var perStore=Ext.create("Rally.data.wsapi.Store",{model:"workspacepermission",autoLoad:!0,pageSize:2e3,filters:[{property:"User",value:record.get("_ref")},{property:"Workspace",value:me.getContext().getWorkspace()._ref}],listeners:{load:function(store,data,success){success?(me.workspacePerms=data,deferred.resolve(data)):deferred.reject()}}});return deferred.promise},_workspaceRights:function(){return this.workspacePerms[0]&&"Admin"===this.workspacePerms[0].get("Role")},_getWorkspaceColour:function(){return this._workspaceRights()?"red":"white"},_redrawTree:function(){var currentTree=this.down("#projectTree");currentTree&&currentTree.destroy(),this._drawTree()},_drawTree:function(){var pt=Ext.create("Rally.ui.tree.ProjectTree",{id:"projectTree",itemId:"projectTree",config:{treeItemConfigForRecordFn:function(record){return"workspace"===record.get("_type")?{xtype:"rallyplaintreeitem"}:{xtype:"extendedTreeItem",selectable:!0}},topLevelStoreConfig:{fetch:["Name","State","Workspace"],filters:[{property:"State",value:"Open"},{property:"Projects.State",value:"Open"}],sorters:[{property:"Name",direction:"ASC"}],context:function(){app._getContext(app)}},childItemsStoreConfigForParentRecordFn:function(record){var storeConfig={fetch:["Name","Description","Owner","Children:summary[State]","State","Workspace"],hydrate:["Owner"],sorters:[{property:"Name",direction:"ASC"}]};return"workspace"===record.get("_type")?Ext.apply(storeConfig,{filters:[{property:"Parent",value:"null"}],context:{workspace:record.get("_ref"),project:null}}):Ext.apply(storeConfig,{filters:[{property:"Parent",value:record.get("_ref")}],context:{workspace:record.get("Workspace")._ref,project:null}})}}});this.add(pt)},getSettingsFields:function(){var me=this;return[{xtype:"rallycheckboxfield",fieldLabel:"Auto expand tree on load",labelWidth:200,name:"autoExpand"}]},launch:function(){var app=this,userSelected=Ext.getCmp("userSelector");userSelected.on("change",this._fetchUserPermissions,this)}});

            Rally.launchApp('CustomApp', {
                name:"UserPermTree",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
